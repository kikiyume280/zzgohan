<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ごはんクリックゲーム</title>
  <style>
    body { font-family: sans-serif; text-align:center; background:#f1f5f9; margin:0; }
    #gameArea { position: relative; width:100%; height:60vh; background:#fff; overflow:hidden; margin-top:20px; }
    .floatingVideo {
      position:absolute;
      left:50%; transform:translateX(-50%);
      width:200px; pointer-events:none;
    }
    button {
      padding:12px 30px; margin:10px;
      font-size:18px; border-radius:8px; border:none;
      background:#4f46e5; color:white;
    }
    #rankingList { text-align:left; width:260px; margin:0 auto; }
  </style>
</head>
<body>

<h1 id="title">ごはんゲーム</h1>

<!-- ホーム画面 -->
<div id="home">
  <button onclick="startGame()">スタート</button>
  <button onclick="showRanking()">ランキング</button>
</div>

<!-- ゲーム画面 -->
<div id="game" style="display:none;">
  <div>スコア：<span id="score">0</span></div>
  <div id="timer">30</div>
  <div id="gameArea">画面をクリック！</div>
</div>

<!-- 結果画面 -->
<div id="result" style="display:none;">
  <h2>最終スコア：<span id="finalScore"></span></h2>
  <input id="playerName" placeholder="名前" style="padding:10px;font-size:16px;">
  <br>
  <button onclick="registerScore()">ランキングに登録</button>
</div>

<!-- ランキング画面 -->
<div id="ranking" style="display:none;">
  <h2>ランキングTOP10</h2>
  <div id="rankingList"></div>
  <button onclick="goHome()">ホームに戻る</button>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

  // ⚠ ここはあなたの Firebase の設定に書き換えてください
const firebaseConfig = {
  apiKey: "AIzaSyCC7KAv7V4j1Z6-o1Y8ikmb3r5htN9O_aA",
  authDomain: "zzgohan-280.firebaseapp.com",
  databaseURL: "https://zzgohan-280-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "zzgohan-280",
  storageBucket: "zzgohan-280.firebasestorage.app",
  messagingSenderId: "459336048542",
  appId: "1:459336048542:web:ff6c825dec81cc7df8008f",
  measurementId: "G-JX4RP9LWR3"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let score = 0;
  let timeLeft = 30;
  let timerID;

  // ホーム → ゲーム開始
  window.startGame = function(){
    score = 0;
    timeLeft = 30;
    document.getElementById("score").textContent = score;

    show("home", false);
    show("ranking", false);
    show("result", false);
    show("game", true);

    timerID = setInterval(() => {
      timeLeft--;
      document.getElementById("timer").textContent = timeLeft;
      if(timeLeft <= 0) endGame();
    }, 1000);
  }

  // ゲーム終了 → 結果画面
  function endGame(){
    clearInterval(timerID);
    show("game", false);
    document.getElementById("finalScore").textContent = score;
    show("result", true);
  }

  // ランキングに登録
  window.registerScore = function(){
    const name = document.getElementById("playerName").value.trim();
    if(!name) return alert("名前を入れてね");

    const rankRef = ref(db, "ranking");

    // まず今のランキングを取得して重複除去
    onValue(rankRef, (snapshot) => {
      let data = snapshot.val() || {};
      for (let key in data) {
        if(data[key].name === name && data[key].score === score){
          // 既に同じものがある → 消す
          set(ref(db, "ranking/" + key), null);
        }
      }

      // 再度登録
      push(rankRef, {
        name: name,
        score: score
      });

      goHome();
    }, { onlyOnce:true });
  }

  // ランキング表示
  window.showRanking = function(){
    const rankRef = ref(db, "ranking");

    onValue(rankRef, (snapshot) => {
      let list = snapshot.val() || {};
      let arr = Object.values(list);

      // スコア順にソート
      arr.sort((a,b)=>b.score - a.score);

      // 10位まで
      arr = arr.slice(0,10);

      let html = "";
      arr.forEach((r,i)=>{
        html += (i+1)+". "+r.name+" - "+r.score+"<br>";
      });
      document.getElementById("rankingList").innerHTML = html;
    });

    show("home", false);
    show("result", false);
    show("game", false);
    show("ranking", true);
  }

  // クリックで動画出現
  document.getElementById("gameArea").addEventListener("click", () => {
    if(timeLeft <= 0) return;

    score += 10;
    document.getElementById("score").textContent = score;

    spawnVideo();
  });

function spawnVideo(){
  const img = document.createElement("img");

  // ★ ランダム判定（10%でレア）
  const isRare = Math.random() < 0.10;

  // ★ GIF を切り替え
  const normalGif = "https://raw.githubusercontent.com/kikiyume280/zzgohan/main/food.gif";
  const rareGif   = "https://raw.githubusercontent.com/kikiyume280/zzgohan/main/food_rare.gif";

  img.src = (isRare ? rareGif : normalGif) + "?" + Date.now();

  img.className = "floatingVideo";

  // 位置を固定（中央）
  img.style.top = "50%";
  img.style.left = "50%";
  img.style.transform = "translate(-50%, -50%)";

  // サイズ大きめ
  img.style.width = isRare ? "300px" : "260px"; // レアなら少し大きく
  img.style.height = "auto";

  document.getElementById("gameArea").appendChild(img);

  // ★ スコア加算（ここに移動）
  if(isRare){
    score += 100;
  } else {
    score += 10;
  }
  document.getElementById("score").textContent = score;

  // ⭐ GIF の表示時間コントロール（例：600ms）
  setTimeout(() => {
    img.remove();
  }, isRare ? 700 : 600);  // レアは少し長く見せても良い
}




  // 汎用表示切替
  function show(id, bool){
    document.getElementById(id).style.display = bool ? "block" : "none";
  }

  window.goHome = function(){
    show("result", false);
    show("ranking", false);
    show("game", false);
    show("home", true);
  }
</script>

</body>
</html>
